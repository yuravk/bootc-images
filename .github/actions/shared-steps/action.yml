name: "Build and Push"

inputs:
  VERSION_MAJOR:
    required: true
  DATE_STAMP:
    required: true
  IMAGE_REGISTRY:
    required: true
  REGISTRY_USER:
    required: true
  REGISTRY_PASSWORD:
    required: true
runs:
  using: "composite"
  steps:
    - name: Prepare environment
      shell: bash
      run: |
        # Platform / arch, like: amd64, arm64, amd64_v2
        platform="${{ env.PLATFORM }}"
        ARCH=${platform#linux/}; ARCH="${ARCH/\//_}"
        [ "x${ARCH}" != "x" ] && echo "ARCH=${ARCH}" >> "$GITHUB_ENV"

        # Platform / machine, like: x86_64, aarch64
        MACHINE=x86_64
        [ "$ARCH" = "arm64" ] && MACHINE=aarch64
        [[ ${{ env.PLATFORM }} = *'v2'* ]] && MACHINE=x86_64_v2
        echo "MACHINE=${MACHINE}" >> "$GITHUB_ENV"

        # Pull tag and directory with Containerfile, like: 9, 10-kitten
        PULL_TAG=${{ inputs.VERSION_MAJOR }}
        [[ ${{ env.PLATFORM }} = *'v2'* ]] && PULL_TAG="${PULL_TAG/-x86_64_v2/}"
        echo "PULL_TAG=${PULL_TAG}" >> "$GITHUB_ENV"

        # Minor version
        VERSION_MINOR=
        if [[ ${{ inputs.VERSION_MAJOR }} != *'kitten'* ]]; then
          release=$(rpm -q --qf="%{VERSION}\n" https://repo.almalinux.org/almalinux/almalinux-release-latest-${{ inputs.VERSION_MAJOR }}.${MACHINE}.rpm 2>/dev/null)
          VERSION_MINOR=.$(cut -d '.' -f 2 <<< "$release")
        fi
        echo "VERSION_MINOR=${VERSION_MINOR}" >> "$GITHUB_ENV"

        # quay.io/almalinuxorg/almalinux-bootc
        IMAGE_DEST=${{ inputs.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}
        echo "IMAGE_DEST=${IMAGE_DEST}" >> "$GITHUB_ENV"

    - name: Check update
      shell: bash
      run: |
        # 'dnf check-update'
        # exit codes:
        #   0 - no updates
        #   100 - updates available
        #   125 - tag/platform not found
        #   127 - command not found
        res=0
        podman run --quiet --rm --platform=${{ env.PLATFORM }} ${{ inputs.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.PULL_TAG }} dnf check-update || res=$?
        echo "res=${res}" >> "$GITHUB_ENV"
        echo "Exit code: '$res'"

    - name: Build image
      if: ${{ env.res != 0 }}
      shell: bash
      run: |
        podman build \
          --platform=${{ env.PLATFORM }} \
          --security-opt=label=disable \
          --cap-add=all \
          --device /dev/fuse \
          -t ${{ env.IMAGE_NAME }} \
          -f ${{ env.PULL_TAG }}/Containerfile \
        .

    - name: Run Image
      if: ${{ env.res != 0 }}
      shell: bash
      run: podman run --platform=${{ env.PLATFORM }} --rm -ti ${{ env.IMAGE_NAME }} bootc --version

    - name: Log in to registry
      if: ${{ env.res != 0 }}
      shell: bash
      run: podman login ${{ inputs.IMAGE_REGISTRY }} -u ${{ inputs.REGISTRY_USER }} -p ${{ inputs.REGISTRY_PASSWORD }}

    - name: Push to registry
      if: ${{ env.res != 0 }}
      shell: bash
      run: |
        # Tag: VERSION_MAJOR.VERSION_MINOR-DATE_STAMP-ARCH
        podman push ${{ env.IMAGE_NAME }} \
          docker://${IMAGE_DEST}:${{ inputs.VERSION_MAJOR }}${{ env.VERSION_MINOR }}-${{ inputs.DATE_STAMP }}-${{ env.ARCH }}
